
server {
    listen 80;
    server_name genaipoconline.online www.genaipoconline.online;

    root /var/www/html;
    index index.html index.htm;
}

Put above first. Later when certifictes are downloaded rest wil be take care

server {
    if ($host = www.genaipoconline.online) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = genaipoconline.online) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name genaipoconline.online www.genaipoconline.online;
    return 404; # managed by Certbot

}


server {
    server_name genaipoconline.online www.genaipoconline.online;

    root /var/www/html;
    index index.html index.htm;

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/genaipoconline.online/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/genaipoconline.online/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    proxy_connect_timeout 300;
    proxy_send_timeout 300;
    proxy_read_timeout 300;
    send_timeout 300;

# -----------------------------
    # 1. STREAMLIT FRONTEND
    # -----------------------------
    location / {

        proxy_pass http://127.0.0.1:8501/;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_read_timeout 300;
        proxy_send_timeout 300;
        proxy_connect_timeout 300;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";
    }

    # Streamlit WebSocket internal API
    location /_stcore/ {
        proxy_pass http://127.0.0.1:8501/_stcore/;
        proxy_http_version 1.1;


        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }


   # Streamlit static resources
    location /static/ {
        proxy_pass http://127.0.0.1:8501/static/;
        proxy_http_version 1.1;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

    }

    location /stream {
        proxy_pass http://127.0.0.1:8501/stream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # Timeout fixes
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

    }

    # -----------------------------
    # 2. FASTAPI BACKEND ( /api/* )
    # -----------------------------
    # /api/login  → backend:8000/login
    # /api/query  → backend:8000/query
    # /api/logout → backend:8000/logout
    #
    location /api/ {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:8000/;    # IMPORTANT: trailing slash strips /api/
         # FIX TIMEOUTS FOR SLOW LLM REQUESTS
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

        send_timeout 300;


        proxy_http_version 1.1;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # forward JWT Authorization header to FastAPI
        proxy_set_header Authorization     $http_authorization;
    }
}

